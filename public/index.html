<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leferi Selects Lab | 화장품 전성분 데이터베이스</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    @font-face { font-family: 'Leferi Base'; src: url('fonts/LeferiBaseRegular.ttf') format('truetype'); font-weight: 400; }
    @font-face { font-family: 'Leferi Base'; src: url('fonts/LeferiBaseBold.ttf') format('truetype'); font-weight: 700; }
    @font-face { font-family: 'Leferi Point'; src: url('fonts/LeferiPointBlack.ttf') format('truetype'); font-weight: 900; }

    :root {
      --bg-primary: #f8fafa; --bg-secondary: #ffffff; --bg-accent: #f0f5f4;
      --text-primary: #1a1a1a; --text-secondary: #4a5568; --text-muted: #718096;
      --border-color: #e2e8f0;
      --teal-50: #f0fdfa; --teal-100: #ccfbf1; --teal-500: #14b8a6; --teal-600: #0d9488; --teal-700: #0f766e;
      --accent-gradient: linear-gradient(135deg, #0d9488 0%, #14b8a6 50%, #2dd4bf 100%);
      --danger: #ef4444; --success: #10b981;
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07); --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08); --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 24px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Leferi Base', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.7; }

    /* 로그인 */
    .login-screen { position: fixed; inset: 0; background: url('login-bg.png') center/cover; display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .login-screen::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(10,39,37,0.7), rgba(13,148,136,0.4)); }
    .login-box { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 3rem; border-radius: var(--radius-xl); box-shadow: 0 25px 50px rgba(0,0,0,0.4); text-align: center; max-width: 440px; width: 90%; position: relative; z-index: 1; }
    .login-logo { display: flex; align-items: center; justify-content: center; gap: 14px; margin-bottom: 2.5rem; }
    .login-form { text-align: left; }
    .login-error { color: var(--danger); font-size: 0.85rem; margin-top: 12px; text-align: center; }
    .login-btn { width: 100%; margin-top: 16px; padding: 14px; background: var(--accent-gradient); border: none; border-radius: var(--radius-md); color: white; font-family: 'Leferi Base'; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s; }
    .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(13,148,136,0.3); }

    /* 헤더 */
    .header { background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); padding: 0 2.5rem; position: sticky; top: 0; z-index: 100; }
    .header-inner { max-width: 1600px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 72px; }
    .logo { display: flex; align-items: center; gap: 14px; text-decoration: none; color: inherit; }
    .logo-icon { width: 44px; height: 44px; background: var(--accent-gradient); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: white; font-size: 22px; box-shadow: 0 4px 12px rgba(13,148,136,0.3); }
    .logo-text { font-family: 'Leferi Point'; font-size: 1.35rem; font-weight: 900; background: linear-gradient(135deg, var(--teal-700), var(--teal-500)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .logo-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: -2px; }
    .header-actions { display: flex; gap: 10px; }

    /* 버튼 */
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: var(--radius-sm); font-family: 'Leferi Base'; font-size: 0.9rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.25s; }
    .btn-primary { background: var(--accent-gradient); color: white; box-shadow: 0 4px 12px rgba(13,148,136,0.25); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(13,148,136,0.35); }
    .btn-secondary { background: white; color: var(--text-secondary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { border-color: var(--teal-500); color: var(--teal-700); }
    .btn-olive { background: var(--accent-gradient); color: white; }
    .btn-icon { padding: 10px; aspect-ratio: 1; }

    /* 레이아웃 */
    .main-container { max-width: 1600px; margin: 0 auto; padding: 2rem 2.5rem; display: grid; grid-template-columns: 280px 1fr; gap: 2.5rem; }
    .sidebar { display: flex; flex-direction: column; gap: 1.5rem; position: sticky; top: 104px; height: fit-content; }
    .sidebar-section { background: var(--bg-secondary); border-radius: var(--radius-lg); padding: 1.5rem; border: 1px solid var(--border-color); }
    .sidebar-title { font-family: 'Leferi Point'; font-size: 0.8rem; font-weight: 900; color: var(--teal-700); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; display: flex; align-items: center; gap: 8px; }
    .sidebar-title::before { content: ''; width: 4px; height: 16px; background: var(--accent-gradient); border-radius: 2px; }

    .search-box { position: relative; }
    .search-box input { width: 100%; padding: 12px 16px 12px 44px; border: 2px solid var(--border-color); border-radius: var(--radius-sm); font-family: 'Leferi Base'; font-size: 0.95rem; background: var(--bg-primary); transition: all 0.25s; }
    .search-box input:focus { outline: none; border-color: var(--teal-500); background: white; box-shadow: 0 0 0 4px rgba(13,148,136,0.1); }
    .search-box i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

    .filter-list { list-style: none; }
    .filter-item { padding: 10px 14px; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s; color: var(--text-secondary); margin-bottom: 4px; }
    .filter-item:hover { background: var(--teal-50); color: var(--teal-700); }
    .filter-item.active { background: var(--accent-gradient); color: white; box-shadow: 0 4px 12px rgba(13,148,136,0.25); }
    .filter-item .count { background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; }
    .filter-item:not(.active) .count { background: var(--bg-accent); color: var(--text-muted); }

    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .stat-card { background: linear-gradient(135deg, var(--teal-50), white); padding: 1.25rem; border-radius: var(--radius-md); text-align: center; border: 1px solid var(--teal-100); }
    .stat-value { font-family: 'Leferi Point'; font-size: 1.75rem; font-weight: 900; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

    .content { min-height: 70vh; }
    .content-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
    .content-title { font-family: 'Leferi Point'; font-size: 1.5rem; font-weight: 900; }
    .content-title span { color: var(--teal-600); }

    .view-toggle { display: flex; gap: 6px; }
    .view-btn { width: 40px; height: 40px; border: 1px solid var(--border-color); background: white; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); transition: all 0.2s; }
    .view-btn.active { background: var(--accent-gradient); color: white; border-color: transparent; }

    /* 제품 카드 */
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
    .product-card { background: var(--bg-secondary); border-radius: var(--radius-lg); border: 1px solid var(--border-color); overflow: hidden; transition: all 0.3s; cursor: pointer; position: relative; }
    .product-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--accent-gradient); opacity: 0; transition: opacity 0.3s; }
    .product-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-xl); }
    .product-card:hover::before { opacity: 1; }
    .product-image { height: 200px; background: linear-gradient(135deg, var(--teal-50), var(--bg-accent)); display: flex; align-items: center; justify-content: center; color: var(--teal-500); font-size: 3.5rem; overflow: hidden; }
    .product-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
    .product-card:hover .product-image img { transform: scale(1.05); }
    .product-body { padding: 1.5rem; }
    .product-category { display: inline-block; background: var(--teal-50); color: var(--teal-700); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; margin-bottom: 10px; }
    .product-brand { font-size: 0.85rem; color: var(--teal-600); font-weight: 700; margin-bottom: 4px; }
    .product-name { font-family: 'Leferi Point'; font-size: 1.1rem; font-weight: 900; margin-bottom: 12px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .product-meta { display: flex; gap: 16px; font-size: 0.85rem; color: var(--text-muted); padding-top: 12px; border-top: 1px solid var(--border-color); }
    .product-meta span { display: flex; align-items: center; gap: 6px; }
    .product-meta i { color: var(--teal-500); }

    .ingredient-preview { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
    .ingredient-tags { display: flex; flex-wrap: wrap; gap: 6px; }
    .ingredient-tag { background: var(--bg-accent); padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; color: var(--text-secondary); border: 1px solid var(--border-color); }
    .ingredient-more { color: var(--teal-600); font-size: 0.75rem; font-weight: 500; }

    .products-list { display: flex; flex-direction: column; gap: 12px; }
    .product-list-item { background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-color); padding: 1.25rem 1.5rem; display: grid; grid-template-columns: auto 1fr auto; gap: 1.5rem; align-items: center; transition: all 0.25s; cursor: pointer; }
    .product-list-item:hover { border-color: var(--teal-500); box-shadow: var(--shadow-md); transform: translateX(4px); }
    .product-list-thumb { width: 70px; height: 70px; background: linear-gradient(135deg, var(--teal-50), var(--bg-accent)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: var(--teal-500); }
    .product-list-thumb img { width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-sm); }
    .product-list-info { min-width: 0; }
    .product-list-actions { display: flex; gap: 8px; }

    .empty-state { text-align: center; padding: 5rem 2rem; color: var(--text-muted); background: linear-gradient(135deg, var(--teal-50), white); border-radius: var(--radius-xl); border: 2px dashed var(--teal-100); }
    .empty-state i { font-size: 5rem; margin-bottom: 1.5rem; color: var(--teal-500); }
    .empty-state h3 { font-family: 'Leferi Point'; font-size: 1.4rem; color: var(--text-secondary); font-weight: 900; }

    /* 모달 */
    .modal-overlay { position: fixed; inset: 0; background: rgba(10,39,37,0.6); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--bg-secondary); border-radius: var(--radius-xl); width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; transform: translateY(20px) scale(0.95); transition: all 0.3s; box-shadow: var(--shadow-xl); }
    .modal-overlay.active .modal { transform: translateY(0) scale(1); }
    .modal-header { padding: 1.75rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, var(--teal-50), white); }
    .modal-title { font-family: 'Leferi Point'; font-size: 1.35rem; font-weight: 900; display: flex; align-items: center; gap: 10px; }
    .modal-title i { color: var(--teal-600); }
    .modal-close { width: 40px; height: 40px; border: none; background: white; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); transition: all 0.2s; }
    .modal-close:hover { background: var(--danger); color: white; transform: rotate(90deg); }
    .modal-body { padding: 2rem; }
    .modal-footer { padding: 1.25rem 2rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; background: var(--bg-primary); }

    .form-group { margin-bottom: 1.5rem; }
    .form-label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); }
    .form-input { width: 100%; padding: 14px 18px; border: 2px solid var(--border-color); border-radius: var(--radius-sm); font-family: 'Leferi Base'; font-size: 0.95rem; transition: all 0.25s; background: var(--bg-primary); }
    .form-input:focus { outline: none; border-color: var(--teal-500); background: white; box-shadow: 0 0 0 4px rgba(13,148,136,0.1); }
    textarea.form-input { min-height: 120px; resize: vertical; }
    .form-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: 6px; }

    .detail-header { display: flex; gap: 2rem; margin-bottom: 2rem; }
    .detail-image { width: 220px; height: 220px; background: linear-gradient(135deg, var(--teal-50), var(--bg-accent)); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: var(--shadow-md); }
    .detail-image img { width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-lg); }
    .detail-info { flex: 1; }
    .detail-brand { font-size: 0.9rem; color: var(--teal-600); font-weight: 700; margin-bottom: 4px; }
    .detail-name { font-family: 'Leferi Point'; font-size: 1.6rem; font-weight: 900; margin-bottom: 16px; line-height: 1.3; }
    .detail-meta { display: flex; gap: 20px; flex-wrap: wrap; padding: 16px; background: var(--teal-50); border-radius: var(--radius-md); }
    .detail-meta-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
    .detail-meta-item i { color: var(--teal-600); }

    .ingredients-section { margin-top: 2rem; }
    .ingredients-title { font-family: 'Leferi Point'; font-size: 1.1rem; font-weight: 900; margin-bottom: 1rem; display: flex; align-items: center; gap: 8px; color: var(--teal-700); }
    .ingredients-title i { color: var(--teal-500); }
    .ingredients-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .ingredient-item { background: white; padding: 8px 16px; border-radius: 25px; font-size: 0.85rem; border: 1px solid var(--border-color); transition: all 0.2s; }
    .ingredient-item:hover { background: var(--teal-50); border-color: var(--teal-500); }
    .ingredient-number { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; background: var(--accent-gradient); color: white; border-radius: 50%; font-size: 0.7rem; font-weight: 700; margin-right: 8px; }

    /* 크롤링 */
    .crawl-search-box { display: flex; gap: 12px; margin-bottom: 1.5rem; }
    .crawl-search-box input { flex: 1; }
    .search-results-container { max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-primary); }
    .search-results-title { padding: 1rem 1.25rem; font-weight: 700; border-bottom: 1px solid var(--border-color); background: white; color: var(--teal-700); position: sticky; top: 0; }
    .search-result-item { display: flex; align-items: center; gap: 14px; padding: 14px 1.25rem; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; background: white; }
    .search-result-item:hover { background: var(--teal-50); }
    .search-result-item.selected { background: linear-gradient(135deg, var(--teal-50), white); border-left: 4px solid var(--teal-500); }
    .search-result-thumb { width: 56px; height: 56px; background: var(--bg-accent); border-radius: var(--radius-sm); overflow: hidden; flex-shrink: 0; }
    .search-result-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .search-result-info { flex: 1; min-width: 0; }
    .search-result-brand { font-size: 0.8rem; color: var(--teal-600); font-weight: 600; }
    .search-result-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .search-result-price { font-size: 0.85rem; color: var(--text-muted); }
    .search-result-check { color: var(--teal-500); font-size: 1.4rem; opacity: 0; transition: opacity 0.2s; }
    .search-result-item.selected .search-result-check { opacity: 1; }
    .crawl-actions { display: flex; align-items: center; justify-content: space-between; padding: 1rem 0; border-top: 1px solid var(--border-color); margin-top: 1rem; }
    .selected-count { font-weight: 600; color: var(--teal-700); }
    .crawl-status { max-height: 300px; overflow-y: auto; background: var(--bg-primary); border-radius: var(--radius-md); padding: 1rem; }
    .crawl-status-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: white; border-radius: var(--radius-sm); margin-bottom: 8px; font-size: 0.9rem; border: 1px solid var(--border-color); }
    .crawl-status-item.success { border-color: var(--success); background: #f0fdf4; }
    .crawl-status-item.success i { color: var(--success); }
    .crawl-status-item.error { border-color: var(--danger); background: #fef2f2; }
    .crawl-status-item.error i { color: var(--danger); }
    .crawl-status-item.loading i { color: var(--teal-500); animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: white; padding: 16px 24px; border-radius: var(--radius-md); box-shadow: var(--shadow-xl); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s; border-left: 4px solid var(--teal-500); }
    .toast.success { border-left-color: var(--success); }
    .toast.success i { color: var(--success); }
    .toast.error { border-left-color: var(--danger); }
    .toast.error i { color: var(--danger); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    @media (max-width: 1024px) { .main-container { grid-template-columns: 1fr; padding: 1.5rem; } .sidebar { position: static; } .header { padding: 0 1.5rem; } .btn span { display: none; } }
    @media (max-width: 640px) { .products-grid { grid-template-columns: 1fr; } .modal { width: 95%; } .detail-header { flex-direction: column; } .detail-image { width: 100%; height: 280px; } .login-box { padding: 2rem; } }
  </style>
</head>
<body>
<!-- 로그인 화면 -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <div class="logo-icon"><i class="ri-flask-line"></i></div>
      <div>
        <div class="logo-text">Leferi Selects Lab</div>
        <div class="logo-sub">레페리 품평실</div>
      </div>
    </div>
    <div class="login-form">
      <label class="form-label">접속 코드를 입력하세요</label>
      <input type="password" id="accessCodeInput" class="form-input" placeholder="접속 코드" onkeypress="if(event.key==='Enter') verifyAccess()">
      <button class="login-btn" onclick="verifyAccess()"><i class="ri-login-box-line"></i> 접속하기</button>
      <p id="loginError" class="login-error"></p>
    </div>
  </div>
</div>

<!-- 메인 앱 -->
<div id="mainApp" style="display: none;">
<header class="header">
  <div class="header-inner">
    <a href="#" class="logo">
      <div class="logo-icon"><i class="ri-flask-line"></i></div>
      <div>
        <div class="logo-text">Leferi Selects Lab</div>
        <div class="logo-sub">화장품 전성분 데이터베이스</div>
      </div>
    </a>
    <div class="header-actions">
      <button class="btn btn-olive" onclick="openCrawlModal()"><i class="ri-download-cloud-line"></i><span> 올리브영 크롤링</span></button>
      <button class="btn btn-secondary" onclick="exportCSV()"><i class="ri-download-2-line"></i><span> 내보내기</span></button>
      <button class="btn btn-secondary" onclick="document.getElementById('csvInput').click()"><i class="ri-upload-2-line"></i><span> 가져오기</span></button>
      <input type="file" id="csvInput" accept=".csv" hidden onchange="importCSV(this)">
      <button class="btn btn-primary" onclick="openAddModal()"><i class="ri-add-line"></i><span> 수동 추가</span></button>
      <button class="btn btn-secondary btn-icon" onclick="logout()" title="로그아웃"><i class="ri-logout-box-r-line"></i></button>
    </div>
  </div>
</header>

<main class="main-container">
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">검색</div>
      <div class="search-box">
        <i class="ri-search-line"></i>
        <input type="text" id="searchInput" placeholder="브랜드, 제품명, 성분..." oninput="debounceSearch()">
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">브랜드 필터</div>
      <ul class="filter-list" id="brandFilter">
        <li class="filter-item active" data-brand=""><span>전체 보기</span><span class="count" id="totalCount">0</span></li>
      </ul>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">통계</div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="statProducts">0</div><div class="stat-label">등록 제품</div></div>
        <div class="stat-card"><div class="stat-value" id="statBrands">0</div><div class="stat-label">브랜드</div></div>
        <div class="stat-card"><div class="stat-value" id="statIngredients">0</div><div class="stat-label">총 성분</div></div>
        <div class="stat-card"><div class="stat-value" id="statAvgIngredients">0</div><div class="stat-label">평균 성분수</div></div>
      </div>
    </div>
  </aside>

  <section class="content">
    <div class="content-header">
      <h2 class="content-title">전체 제품 <span id="filteredCount"></span></h2>
      <div class="view-toggle">
        <button class="view-btn active" onclick="setView('grid')"><i class="ri-grid-fill"></i></button>
        <button class="view-btn" onclick="setView('list')"><i class="ri-list-check"></i></button>
      </div>
    </div>
    <div id="productsContainer"></div>
  </section>
</main>

<!-- 추가 모달 -->
<div class="modal-overlay" id="addModal">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <h3 class="modal-title"><i class="ri-add-circle-line"></i> 새 제품 추가</h3>
      <button class="modal-close" onclick="closeModal('addModal')"><i class="ri-close-line"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">브랜드명 *</label><input type="text" id="addBrand" class="form-input" placeholder="예: 아이소이"></div>
      <div class="form-group"><label class="form-label">제품명 *</label><input type="text" id="addName" class="form-input" placeholder="예: 불가리안 로즈 비타 워터 에센스"></div>
      <div class="form-group"><label class="form-label">카테고리</label><input type="text" id="addCategory" class="form-input" placeholder="예: 에센스"></div>
      <div class="form-group"><label class="form-label">전성분</label><textarea id="addIngredients" class="form-input" placeholder="쉼표(,)로 구분하여 입력"></textarea><p class="form-hint">전성분을 쉼표로 구분하여 입력하세요.</p></div>
      <div class="form-group"><label class="form-label">올리브영 URL</label><input type="text" id="addOliveyoungUrl" class="form-input" placeholder="https://..."></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addModal')">취소</button>
      <button class="btn btn-primary" onclick="saveProduct()"><i class="ri-check-line"></i> 저장</button>
    </div>
  </div>
</div>

<!-- 상세 모달 -->
<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title"><i class="ri-flask-line"></i> 제품 상세</h3>
      <button class="modal-close" onclick="closeModal('detailModal')"><i class="ri-close-line"></i></button>
    </div>
    <div class="modal-body" id="detailContent"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="editCurrentProduct()"><i class="ri-edit-line"></i> 수정</button>
      <button class="btn btn-secondary" style="color: var(--danger)" onclick="deleteCurrentProduct()"><i class="ri-delete-bin-line"></i> 삭제</button>
    </div>
  </div>
</div>

<!-- 크롤링 모달 -->
<div class="modal-overlay" id="crawlModal">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header">
      <h3 class="modal-title"><i class="ri-download-cloud-line"></i> 올리브영 크롤링</h3>
      <button class="modal-close" onclick="closeModal('crawlModal')"><i class="ri-close-line"></i></button>
    </div>
    <div class="modal-body" id="crawlContent"></div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>
</div>

<script>
  let products = [], filteredProducts = [], currentView = 'grid', currentBrand = '', currentProduct = null, searchTimeout = null, crawlerAvailable = false, selectedProducts = [], accessCode = '';
  const API_URL = '';

  document.addEventListener('DOMContentLoaded', () => {
    const savedCode = localStorage.getItem('accessCode');
    if (savedCode) { accessCode = savedCode; showMainApp(); }
  });

  async function verifyAccess() {
    const code = document.getElementById('accessCodeInput').value;
    const errorEl = document.getElementById('loginError');
    if (!code) { errorEl.textContent = '접속 코드를 입력하세요.'; return; }
    try {
      const res = await fetch(`${API_URL}/api/auth/verify`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code }) });
      const data = await res.json();
      if (data.success) { accessCode = code; localStorage.setItem('accessCode', code); showMainApp(); }
      else { errorEl.textContent = data.error || '접속 코드가 올바르지 않습니다.'; document.getElementById('accessCodeInput').value = ''; }
    } catch (err) { errorEl.textContent = '서버 연결에 실패했습니다.'; }
  }

  function showMainApp() { document.getElementById('loginScreen').style.display = 'none'; document.getElementById('mainApp').style.display = 'block'; loadProducts(); checkCrawlerStatus(); }
  function logout() { if (confirm('로그아웃 하시겠습니까?')) { localStorage.removeItem('accessCode'); accessCode = ''; document.getElementById('loginScreen').style.display = 'flex'; document.getElementById('mainApp').style.display = 'none'; document.getElementById('accessCodeInput').value = ''; document.getElementById('loginError').textContent = ''; } }

  async function checkCrawlerStatus() { try { const res = await fetch(`${API_URL}/api/crawler/status`); const data = await res.json(); crawlerAvailable = data.available; } catch (err) { crawlerAvailable = false; } }

  async function loadProducts() {
    try {
      const res = await fetch(`${API_URL}/api/products`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      products = Array.isArray(data) ? data : [];
      filteredProducts = products;
      updateUI();
    } catch (err) { console.error('Failed to load products:', err); if (products.length === 0) showToast('데이터를 불러오는데 실패했습니다.', 'error'); }
  }

  function updateUI() { updateStats(); updateBrandFilter(); renderProducts(); }
  function updateStats() {
    const brands = new Set(products.map(p => p.brand));
    const totalIngredients = products.reduce((sum, p) => sum + (p.ingredients?.length || 0), 0);
    document.getElementById('statProducts').textContent = products.length;
    document.getElementById('statBrands').textContent = brands.size;
    document.getElementById('statIngredients').textContent = totalIngredients;
    document.getElementById('statAvgIngredients').textContent = products.length ? Math.round(totalIngredients / products.length) : 0;
    document.getElementById('totalCount').textContent = products.length;
  }
  function updateBrandFilter() {
    const brandCounts = {};
    products.forEach(p => { brandCounts[p.brand] = (brandCounts[p.brand] || 0) + 1; });
    const sortedBrands = Object.entries(brandCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const container = document.getElementById('brandFilter');
    container.innerHTML = `<li class="filter-item ${!currentBrand ? 'active' : ''}" onclick="filterByBrand('')"><span>전체 보기</span><span class="count">${products.length}</span></li>`;
    sortedBrands.forEach(([brand, count]) => {
      container.innerHTML += `<li class="filter-item ${currentBrand === brand ? 'active' : ''}" onclick="filterByBrand('${brand}')"><span>${brand}</span><span class="count">${count}</span></li>`;
    });
  }
  function filterByBrand(brand) { currentBrand = brand; applyFilters(); updateBrandFilter(); }
  function debounceSearch() { clearTimeout(searchTimeout); searchTimeout = setTimeout(applyFilters, 300); }
  function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    filteredProducts = products.filter(p => {
      const matchBrand = !currentBrand || p.brand === currentBrand;
      const matchSearch = !search || p.brand.toLowerCase().includes(search) || p.name.toLowerCase().includes(search) || (p.ingredients || []).some(i => i.toLowerCase().includes(search));
      return matchBrand && matchSearch;
    });
    document.getElementById('filteredCount').textContent = `(${filteredProducts.length}개)`;
    renderProducts();
  }
  function setView(view) { currentView = view; document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active')); document.querySelector(`.view-btn:${view === 'grid' ? 'first-child' : 'last-child'}`).classList.add('active'); renderProducts(); }
  function renderProducts() {
    const container = document.getElementById('productsContainer');
    if (filteredProducts.length === 0) { container.innerHTML = `<div class="empty-state"><i class="ri-flask-line"></i><h3>등록된 제품이 없습니다</h3><p>새 제품을 추가하거나 올리브영에서 크롤링하세요.</p></div>`; return; }
    if (currentView === 'grid') {
      container.innerHTML = `<div class="products-grid">${filteredProducts.map(p => `
        <div class="product-card" onclick="showDetail('${p._id}')">
          <div class="product-image">${p.imageUrl ? `<img src="${p.imageUrl}" alt="${p.name}">` : '<i class="ri-flask-line"></i>'}</div>
          <div class="product-body">
            ${p.category ? `<span class="product-category">${p.category}</span>` : ''}
            <div class="product-brand">${p.brand}</div>
            <div class="product-name">${p.name}</div>
            <div class="product-meta"><span><i class="ri-test-tube-line"></i> ${(p.ingredients || []).length}개 성분</span></div>
            ${(p.ingredients || []).length > 0 ? `<div class="ingredient-preview"><div class="ingredient-tags">${(p.ingredients || []).slice(0, 3).map(i => `<span class="ingredient-tag">${i}</span>`).join('')}${(p.ingredients || []).length > 3 ? `<span class="ingredient-more">+${(p.ingredients || []).length - 3}</span>` : ''}</div></div>` : ''}
          </div>
        </div>`).join('')}</div>`;
    } else {
      container.innerHTML = `<div class="products-list">${filteredProducts.map(p => `
        <div class="product-list-item" onclick="showDetail('${p._id}')">
          <div class="product-list-thumb">${p.imageUrl ? `<img src="${p.imageUrl}">` : '<i class="ri-flask-line"></i>'}</div>
          <div class="product-list-info">
            <div class="product-brand">${p.brand}</div>
            <div class="product-name">${p.name}</div>
            <div class="product-meta"><span><i class="ri-test-tube-line"></i> ${(p.ingredients || []).length}개 성분</span></div>
          </div>
        </div>`).join('')}</div>`;
    }
  }

  function openModal(id) { document.getElementById(id).classList.add('active'); }
  function closeModal(id) { 
    document.getElementById(id).classList.remove('active'); 
    if (id === 'crawlModal') loadProducts();
  }
  function openAddModal() { document.getElementById('addBrand').value = ''; document.getElementById('addName').value = ''; document.getElementById('addCategory').value = ''; document.getElementById('addIngredients').value = ''; document.getElementById('addOliveyoungUrl').value = ''; openModal('addModal'); }

  async function saveProduct() {
    const brand = document.getElementById('addBrand').value.trim();
    const name = document.getElementById('addName').value.trim();
    if (!brand || !name) { showToast('브랜드와 제품명은 필수입니다.', 'error'); return; }
    const ingredients = document.getElementById('addIngredients').value.split(',').map(i => i.trim()).filter(i => i);
    try {
      const res = await fetch(`${API_URL}/api/products`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ brand, name, category: document.getElementById('addCategory').value.trim(), ingredients, oliveyoungUrl: document.getElementById('addOliveyoungUrl').value.trim() }) });
      if (res.ok) { closeModal('addModal'); await loadProducts(); showToast('제품이 추가되었습니다.', 'success'); }
    } catch (err) { showToast('저장 중 오류가 발생했습니다.', 'error'); }
  }

  function showDetail(id) {
    const product = products.find(p => p._id === id);
    if (!product) return;
    currentProduct = product;
    document.getElementById('detailContent').innerHTML = `
      <div class="detail-header">
        <div class="detail-image">${product.imageUrl ? `<img src="${product.imageUrl}">` : '<i class="ri-flask-line" style="font-size:4rem;color:var(--teal-500)"></i>'}</div>
        <div class="detail-info">
          <div class="detail-brand">${product.brand}</div>
          <div class="detail-name">${product.name}</div>
          <div class="detail-meta">
            ${product.category ? `<div class="detail-meta-item"><i class="ri-price-tag-3-line"></i> ${product.category}</div>` : ''}
            <div class="detail-meta-item"><i class="ri-test-tube-line"></i> ${(product.ingredients || []).length}개 성분</div>
            ${product.oliveyoungUrl ? `<div class="detail-meta-item"><i class="ri-external-link-line"></i> <a href="${product.oliveyoungUrl}" target="_blank" style="color:var(--teal-600)">올리브영</a></div>` : ''}
          </div>
        </div>
      </div>
      <div class="ingredients-section">
        <h4 class="ingredients-title"><i class="ri-list-check-2"></i> 전성분 목록</h4>
        <div class="ingredients-list">${(product.ingredients || []).map((ing, i) => `<span class="ingredient-item"><span class="ingredient-number">${i + 1}</span>${ing}</span>`).join('')}</div>
      </div>`;
    openModal('detailModal');
  }

  function editCurrentProduct() {
    if (!currentProduct) return;
    closeModal('detailModal');
    document.getElementById('addBrand').value = currentProduct.brand;
    document.getElementById('addName').value = currentProduct.name;
    document.getElementById('addCategory').value = currentProduct.category || '';
    document.getElementById('addIngredients').value = (currentProduct.ingredients || []).join(', ');
    document.getElementById('addOliveyoungUrl').value = currentProduct.oliveyoungUrl || '';
    openModal('addModal');
    document.querySelector('#addModal .modal-title').innerHTML = '<i class="ri-edit-line"></i> 제품 수정';
    const saveBtn = document.querySelector('#addModal .btn-primary');
    saveBtn.onclick = async () => {
      try {
        const res = await fetch(`${API_URL}/api/products/${currentProduct._id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ brand: document.getElementById('addBrand').value.trim(), name: document.getElementById('addName').value.trim(), category: document.getElementById('addCategory').value.trim(), ingredients: document.getElementById('addIngredients').value.split(',').map(i => i.trim()).filter(i => i), oliveyoungUrl: document.getElementById('addOliveyoungUrl').value.trim() }) });
        if (res.ok) { closeModal('addModal'); await loadProducts(); showToast('제품이 수정되었습니다.', 'success'); }
      } catch (err) { showToast('수정 중 오류가 발생했습니다.', 'error'); }
    };
  }

  async function deleteCurrentProduct() {
    if (!currentProduct || !confirm('정말 삭제하시겠습니까?')) return;
    try {
      const res = await fetch(`${API_URL}/api/products/${currentProduct._id}`, { method: 'DELETE' });
      if (res.ok) { closeModal('detailModal'); await loadProducts(); showToast('제품이 삭제되었습니다.', 'success'); }
    } catch (err) { showToast('삭제 중 오류가 발생했습니다.', 'error'); }
  }

  async function exportCSV() {
    try { window.location.href = `${API_URL}/api/export/csv`; showToast('CSV 파일을 다운로드합니다.', 'success'); }
    catch (err) { showToast('내보내기 중 오류가 발생했습니다.', 'error'); }
  }

  async function importCSV(input) {
    const file = input.files[0];
    if (!file) return;
    const text = await file.text();
    const lines = text.split('\n').slice(1);
    let imported = 0;
    for (const line of lines) {
      if (!line.trim()) continue;
      const [brand, name, category, ingredients] = line.split(',').map(s => s.replace(/^"|"$/g, '').trim());
      if (brand && name) {
        try {
          await fetch(`${API_URL}/api/products`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ brand, name, category: category || '', ingredients: ingredients ? ingredients.split(',').map(i => i.trim()) : [] }) });
          imported++;
        } catch (e) {}
      }
    }
    input.value = '';
    await loadProducts();
    showToast(`${imported}개 제품을 가져왔습니다.`, 'success');
  }

  function openCrawlModal() {
    selectedProducts = [];
    document.getElementById('crawlContent').innerHTML = crawlerAvailable ? `
      <div class="crawl-search-box"><input type="text" id="crawlQuery" class="form-input" placeholder="올리브영에서 검색할 제품명..." onkeypress="if(event.key==='Enter') searchOliveyoung()"><button class="btn btn-primary" onclick="searchOliveyoung()"><i class="ri-search-line"></i></button></div>
      <div id="crawlResults"></div>
      <div id="crawlActions" style="display:none" class="crawl-actions"><span class="selected-count" id="selectedCount">0개 선택됨</span><button class="btn btn-primary" onclick="crawlSelected()"><i class="ri-download-cloud-line"></i> 선택 제품 크롤링</button></div>
      <div id="crawlProgress"></div>
    ` : `<div class="empty-state" style="padding:2rem"><i class="ri-error-warning-line"></i><h3>크롤링 기능 비활성화</h3><p>Puppeteer가 설치되어 있지 않습니다.</p></div>`;
    openModal('crawlModal');
  }

  async function searchOliveyoung() {
    const query = document.getElementById('crawlQuery').value.trim();
    if (!query) return;
    const resultsDiv = document.getElementById('crawlResults');
    resultsDiv.innerHTML = '<div style="text-align:center;padding:2rem"><i class="ri-loader-4-line" style="animation:spin 1s linear infinite;font-size:2rem;color:var(--teal-500)"></i><p>검색 중...</p></div>';
    try {
      const res = await fetch(`${API_URL}/api/crawler/search?query=${encodeURIComponent(query)}`);
      const results = await res.json();
      if (results.length === 0) { resultsDiv.innerHTML = '<div class="empty-state" style="padding:2rem"><p>검색 결과가 없습니다.</p></div>'; return; }
      selectedProducts = [];
      resultsDiv.innerHTML = `<div class="search-results-container"><div class="search-results-title">검색 결과 (${results.length}개)</div>${results.map(p => `<div class="search-result-item" data-goods-no="${p.goodsNo}" onclick="toggleProductSelection('${p.goodsNo}', this)"><div class="search-result-thumb">${p.imageUrl ? `<img src="${p.imageUrl}">` : ''}</div><div class="search-result-info"><div class="search-result-brand">${p.brand}</div><div class="search-result-name">${p.name}</div><div class="search-result-price">${p.price ? p.price + '원' : ''}</div></div><div class="search-result-check"><i class="ri-checkbox-circle-fill"></i></div></div>`).join('')}</div>`;
      document.getElementById('crawlActions').style.display = 'flex';
    } catch (err) { resultsDiv.innerHTML = `<div class="empty-state" style="padding:2rem"><i class="ri-error-warning-line"></i><h3>검색 중 오류</h3><p>${err.message}</p></div>`; }
  }

  function toggleProductSelection(goodsNo, element) {
    const index = selectedProducts.indexOf(goodsNo);
    if (index > -1) { selectedProducts.splice(index, 1); element.classList.remove('selected'); }
    else { selectedProducts.push(goodsNo); element.classList.add('selected'); }
    document.getElementById('selectedCount').textContent = `${selectedProducts.length}개 선택됨`;
  }

  async function crawlSelected() {
    if (selectedProducts.length === 0) { showToast('크롤링할 제품을 선택하세요.', 'error'); return; }
    const progressDiv = document.getElementById('crawlProgress');
    progressDiv.innerHTML = '<div class="crawl-status"><div class="crawl-status-item loading"><i class="ri-loader-4-line"></i> 크롤링 시작 중...</div></div>';
    try {
      const res = await fetch(`${API_URL}/api/crawler/batch`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ goodsNos: selectedProducts }) });
      const result = await res.json();
      let statusHtml = '<div class="crawl-status">';
      if (result.success) result.success.forEach(s => { statusHtml += `<div class="crawl-status-item success"><i class="ri-checkbox-circle-fill"></i> ${s.name || '제품'} (${s.ingredientCount || 0}개 성분)</div>`; });
      if (result.failed) result.failed.forEach(f => { statusHtml += `<div class="crawl-status-item error"><i class="ri-close-circle-fill"></i> ${f.goodsNo}: ${f.error}</div>`; });
      statusHtml += '</div>';
      progressDiv.innerHTML = statusHtml;
      await new Promise(resolve => setTimeout(resolve, 500));
      await loadProducts();
      if (result.success?.length > 0) showToast(`${result.success.length}개 제품 크롤링 완료!`, 'success');
    } catch (err) { progressDiv.innerHTML = `<div class="crawl-status"><div class="crawl-status-item error"><i class="ri-close-circle-fill"></i> 오류: ${err.message}</div></div>`; }
  }

  async function crawlFromUrl() {
    const urlInput = document.getElementById('crawlUrl').value.trim();
    if (!urlInput) { showToast('URL을 입력하세요.', 'error'); return; }
    
    // goodsNo 추출
    const goodsNoMatch = urlInput.match(/goodsNo=([A-Z0-9]+)/i);
    if (!goodsNoMatch) { showToast('올바른 올리브영 제품 URL이 아닙니다.', 'error'); return; }
    
    const goodsNo = goodsNoMatch[1];
    const progressDiv = document.getElementById('crawlProgress');
    progressDiv.innerHTML = '<div class="crawl-status"><div class="crawl-status-item loading"><i class="ri-loader-4-line"></i> 전성분 크롤링 중...</div></div>';
    
    try {
      const res = await fetch(`${API_URL}/api/crawler/batch`, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify({ goodsNos: [goodsNo] }) 
      });
      const result = await res.json();
      
      let statusHtml = '<div class="crawl-status">';
      if (result.success && result.success.length > 0) {
        result.success.forEach(s => { 
          statusHtml += `<div class="crawl-status-item success"><i class="ri-checkbox-circle-fill"></i> ${s.name || '제품'} - ${s.ingredientCount || 0}개 성분 저장됨</div>`; 
        });
        showToast('크롤링 완료!', 'success');
        await loadProducts();
      }
      if (result.failed && result.failed.length > 0) {
        result.failed.forEach(f => { 
          statusHtml += `<div class="crawl-status-item error"><i class="ri-close-circle-fill"></i> 오류: ${f.error}</div>`; 
        });
      }
      statusHtml += '</div>';
      progressDiv.innerHTML = statusHtml;
      
      // 입력창 초기화
      document.getElementById('crawlUrl').value = '';
      
    } catch (err) { 
      progressDiv.innerHTML = `<div class="crawl-status"><div class="crawl-status-item error"><i class="ri-close-circle-fill"></i> 오류: ${err.message}</div></div>`; 
    }
  }

  function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<i class="ri-${type === 'success' ? 'check' : type === 'error' ? 'close' : 'information'}-line"></i> ${message}`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
</script>
</body>
</html>
